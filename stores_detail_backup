<div id="pop-over">
    <span class="pull-left">
        <div id="pop-over-map-name">Default Name</div>
        <div id="pop-over-map-phone">Phone Number</div>
    </span>
    <span class="pullright"><img src="https://testbucketblurt.s3-us-west-2.amazonaws.com/sites/54205e6a6a616d39c5860000/04dd4f94364d574f0365c89cbafa12c4/btn_search_arrow.png"></span>
</div>
<div class="container">
    <div class="row">
        <div class="col-xs-12 col-sm-4 col-md-3 store-details" id="store_details1">
            <!-- START MUSTACHE TEMPLATE FOR STORE DETAILS-->
            <script id="store_details_template1" type="x-tmpl-mustache">
                <h1>{{name}}</h1>
                <img src="{{store_front_image_url}}">
                <ul>
                    <li style="text-align:center"><h1>{{phone}}</h1></li>
                    <li><a href="/contact_us#opening_hours" class="btn btn-default">HOURS</a></li>
                    <li><a style="width:100%" href="https://{{website}}" target="_blank" class="btn btn-default">VISIT WEBSITE</a></li>
                </ul>
            </script>
            <!-- END MUSTACHE TEMPLATE FOR STORE DETAILS-->
        </div>
        <div class="col-xs-12 col-sm-8 col-md-9">
            <div style="overflow:hidden">
                <div id="zControls">
                    <button class="zoom-in"><span class="glyphicon glyphicon-plus"></span></button>
                    <button class="zoom-out"><span class="glyphicon glyphicon-minus"></span></button>
                    
                </div>
                <div id="map" class="panzoom-elements" style=""></div>
                </div>
            <div id="store_details2">
                <!-- START MUSTACHE TEMPLATE FOR STORE DETAILS-->
                <script id="store_details_template2" type="x-tmpl-mustache">
                    <p>{{description}}</p>
                </script>
            </div>
            <!-- END MUSTACHE TEMPLATE FOR STORE DETAILS-->
             <ul class="promotion-list" id="promotions_not_empty_section" style="display:none">
                <li>
                    <h2>Promotions</h2>
                </li>
                <div id="promotion_list">
                <!-- START MUSTACHE TEMPLATE FOR STORE PROMOTIONS-->
                <script id="promotion_item_template" type="x-tmpl-mustache">
                    <li class="promotion-list-item row">
                        <div class="promo-image col-md-2 col-xs-4">
                            <a href="../promotions/{{ slug }}">
                                <img src="{{promo_image_url}}">
                            </a>
                        </div>
                        <div class="promo-details col-md-10 col-xs-8">
                            <div class="name">
                                <h3><a href="../promotions/{{ slug }}">{{ name }}</a></h3>
                            </div>
                            <div class="promo-store-name">
                                <h4><a href="{{ promo_store_url }}">{{ promo_store_name }}</a></h4>
                            </div>
                            <div class="promo-dates">
                                {{ start_date }} to {{ end_date }}
                            </div>
                            <div class="description">
                                <p>{{ description }}</p>
                            </div>
                            <div class="social-links">
                                <span><a href="#" target="_blank"><img src="https://testbucketblurt.s3-us-west-2.amazonaws.com/sites/54205e6a6a616d39c5860000/251f914efb0a8216e2cd28dd4834e614/share_fb.png"></a></span>
                                <span><a href="#" target="_blank"><img src="https://testbucketblurt.s3-us-west-2.amazonaws.com/sites/54205e6a6a616d39c5860000/251f914efb0a8216e2cd28dd4834e614/share_twit.png"></a></span>
                            </div>
                            </div>
                    </li>
                </script>
                <script id="promotion_item_template_no_image" type="x-tmpl-mustache">
                <li class="promotion-list-item row">
                    <a name="{{promotionable_name}}"></a>
                    <div class="promo-details col-xs-12">
                        <div class="name">
                            <h3><a href="../promotions/{{ slug }}">{{ name }}</a></h3>
                        </div>
                        <div class="store-name">
                            <h4><a href="{{ promotionable_url }}">{{ promotionable_name }}</a></h4>
                        </div>
                        <div class="dates">
                            {{ start_date }} to {{ end_date }}
                        </div>
                        <div class="description">
                            <p>{{ description }}</p>
                        </div>
                        <div class="social-links">
                            <span><a href="#" target="_blank"><img src="https://testbucketblurt.s3-us-west-2.amazonaws.com/sites/54205e6a6a616d39c5860000/251f914efb0a8216e2cd28dd4834e614/share_fb.png"></a></span>
                            <span><a href="#" target="_blank"><img src="https://testbucketblurt.s3-us-west-2.amazonaws.com/sites/54205e6a6a616d39c5860000/251f914efb0a8216e2cd28dd4834e614/share_twit.png"></a></span>
                        </div>
                    </div>
                </li>
            </script>
                <!-- END MUSTACHE TEMPLATE FOR STORE PROMOTIONS-->
                </div>
            </ul>
            <div id="promotions_empty_section"></div>
            <div id="jobs_not_empty_section" class="jobs" style="display:none">
                <h2>Jobs</h2>
                <div class="panel-group" id="accordion">
                    <div id="jobs_list">
                        <!-- START MUSTACHE TEMPLATE FOR JOB ITEM-->
                        <script id="job_item_template" type="x-tmpl-mustache">
                          <div class="panel panel-default">
                            <a data-toggle="collapse" data-parent="#accordion" href="#collapse{{id}}">
                            <div class="panel-heading">
                              <h3 class="panel-title">
                                  {{store_name}}
                              </h3>
                              <h4>
                                {{name}}&nbsp;<small>{{job_type}}</small>
                              </h4>
                            </div>
                            </a>
                            <div id="collapse{{id}}" class="panel-collapse collapse">
                              <div class="panel-body">
                                <p>{{description}}</p>
                                <div style="display:{{has_contact_info_css}}">
                                    <h5>Contact Info</h5>
                                    <div>{{contact_name}}</div>
                                    <div><a href="mailto:{{contact_email}}">{{contact_email}}</a></div>
                                    <div>{{contact_phone}}</div>
                                    <div><a href="{{contact_website}}" target="_blank">{{contact_website}}</a></div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </script>
                        <!-- END MUSTACHE TEMPLATE FOR JOB ITEM-->
                    </div>
                </div>
            </div>
            <div id="jobs_empty_section"></div>
        </div>
    </div>
</div>

<!--For more information please see https://learnjs.io/blog/2013/11/30/snapsvg-resources/-->
<script src="//cdnjs.cloudflare.com/ajax/libs/snap.svg/0.3.0/snap.svg-min.js"></script>
<script src="https://kodekloud.s3.amazonaws.com/sites/5422419e4a616d74d9030000/e1fb5e17ab727d248230fbcb51da868f/jquery.panzoom.min.js"></script>
 
<script>

    $(document).ready(function() {
        var isMobile = ( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) );
        $("#pop-over").hide();
        var didPanZoom = false;
        
        function renderPageData(){
            //renders the store list by referencing the template id and the html id
            //for where to place the rendered content. See mallmaverick.js for implementation
            var pathArray = window.location.pathname.split( '/' );
            var slug = pathArray[pathArray.length-1];
            var store_details = getStoreDetailsBySlug(slug);
            
            checkErrorPage(store_details);
       
            
            renderStoreDetailsTemplate('#store_details_template1','#store_details1',store_details);
            renderStoreDetailsTemplate('#store_details_template2','#store_details2',store_details);
            
            var store_promos = getPromotionsForIds(store_details.promotions);
            renderPromotionsListTemplate('#promotion_item_template','#promotion_item_template_no_image', '#promotion_list','#promotions_not_empty_section','#promotions_empty_section',store_promos);
            
            var jobs = getJobsForIds(store_details.jobs);
            renderJobsListTemplate('#job_item_template','#jobs_list','#jobs_not_empty_section','#jobs_empty_section',jobs);
            $('#loading').hide();
            $('#page_content').fadeIn();
            renderSVGMap(store_details);
            
        }
        
        loadMallData(renderPageData);
        
        function goToStore(store_details){
            if(typeof(store_details) != 'undefined' && store_details != null){
                window.location.href = "/stores/"+store_details.slug;
            }
        }


        function renderSVGMap(store_details){
            if(navigator.appVersion.indexOf("MSIE 9.") == -1){
                $('#map').bind('mousemove', function(e){
                    //console.log(e.pageX+","+e.pageY);
                   $('#pop-over').css({'top':e.pageY+20,'left':e.pageX-70});
                });
                
                var s = Snap("#map");
                var store_svg_id = null;
                if(store_details.svgmap_region != null && typeof(store_details.svgmap_region)  != 'undefined'){
                    store_svg_id = "#"+ store_details.svgmap_region;
                }
               
                var stores = getStoresList();
                Snap.load(getSVGMapURL(), function (f) {
                    
                    
                    if(store_svg_id!=null){
                        f.select(store_svg_id).addClass("map-mouse-over");
                    }
                    $.each( stores, function( key, value ) {
                        if(value.svgmap_region != null && typeof(value.svgmap_region)  != 'undefined'){
                            var svg_id = "#" + value.svgmap_region;
                            f.select(svg_id).mouseover(function() {
                                if(typeof(value) != 'undefined' && value != null){
                                    this.addClass("map-mouse-over");
                                    $("#pop-over").show();
                                    $("#pop-over-map-name").html(value.name);
                                    $("#pop-over-map-phone").html(value.phone);
                                }
                                      
                            });
                            
                            //add the mouse up handler for hiding the pop over when done hovering
                            f.select(svg_id).mouseout(function() {
                                if(store_svg_id != svg_id){
                                    this.removeClass("map-mouse-over");
                                }
                                $("#pop-over").hide(0);
                                
                                
                            });
                            
                            //add the mouse up function for when the user clicks a store
                            f.select(svg_id).mouseup(function() {
                                if(!isMobile && !didPanZoom){
                                    goToStore(value);
                                }
                                didPanZoom = false;
                                      
                            });
                        }
                    });
                   
                    s.append(f.select("svg"));
                    
                });
                    
                
                var startingMapTransform = 'scale(0.43)';
                var startingPanX = -250;
                var startingPanY = -200;
                if(isMobile) {
                        startingMapTransform = 'scale(0.20)';
                        startingPanX = -170;
                        startingPanY = -200;
                }
                $('#loading').hide();
                $( "#page_content" ).fadeIn( "fast", function() {
                    var panzoom = $(".panzoom-elements").panzoom({
                        cursor: "move",
                        increment: 0.1,
                        minScale: 0.15,
                        maxScale: 1,
                        transition: true,
                        duration: 150,
                        easing: "ease-in-out",
                        $zoomIn: $('.zoom-in'),
                        $zoomOut: $('.zoom-out'),
                        $zoomRange: $('.zoom-range'),
                        startTransform: startingMapTransform
            
                    });
                    $(".panzoom-elements").panzoom("pan", startingPanX, startingPanY, { relative: true });
                    
                    panzoom.on('panzoomchange', function(e, panzoom, matrix, changed) {
                      didPanZoom = true;
                    });
                    
                    panzoom.on('panzoomend', function(e, panzoom, matrix, changed) {
                      didPanZoom = false;
                    });
                });
            }else{
                    $('#loading').hide();
                    $('#zControls').hide();
                    $('#map').hide();
                    $( "#page_content" ).fadeIn( "fast");
            }
        }
        
    });
</script>